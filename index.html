<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tropical Cyclone Explorer</title>

  <!-- ── Tailwind (UI) ─────────────────────────────── -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ── OpenLayers (map engine) ───────────────────── -->
  <link  href="https://cdn.jsdelivr.net/npm/ol@9.1.0/ol.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ol@9.1.0/dist/ol.js"></script>

  <style>
    html,body{height:100%}
    #map{height:100%;width:100%}
    /* simple tooltip for storm IDs */
    .ol-tooltip{background:rgba(255,255,255,.9);border:1px solid #ccc;padding:2px 4px;font-size:11px;border-radius:2px;white-space:nowrap}
  </style>
</head>

<body class="h-full w-full flex">
<!-- ─────────────────────────  Sidebar  ────────────────────────── -->
<aside class="w-80 p-4 bg-gray-100 overflow-y-auto">
  <h1 class="text-2xl font-bold mb-4">Tropical Cyclones</h1>
  <input id="search" type="text" placeholder="Search storms…" class="mb-4 w-full p-2 border rounded" />
  <ul   id="storm-list" class="space-y-2"></ul>
</aside>

<!-- ───────────────────────────  Map  ──────────────────────────── -->
<main class="flex-1"><div id="map"></div></main>

<script>
/* ------------------------------------------------------------------ */
/* 1.  OpenLayers base map & vector layer                             */
/* ------------------------------------------------------------------ */
const raster = new ol.layer.Tile({
  source: new ol.source.OSM()
});

/* `wrapX:false` keeps one copy of the data; OpenLayers still draws
   across the antimeridian seamlessly */
const vectorSource = new ol.source.Vector({wrapX:false});

const vectorLayer = new ol.layer.Vector({
  source: vectorSource,
  style : new ol.style.Style({
    stroke: new ol.style.Stroke({color:'#d22',width:2})
  })
});

const map = new ol.Map({
  target : 'map',
  layers : [raster, vectorLayer],
  view   : new ol.View({
    center: ol.proj.fromLonLat([0,20]),
    zoom  : 3
  })
});

/* ------------------------------------------------------------------ */
/* 2.  Tooltip on hover (storm point/segment names)                   */
/* ------------------------------------------------------------------ */
const tooltip = document.createElement('div');
tooltip.className = 'ol-tooltip';
const overlay = new ol.Overlay({element: tooltip, offset:[10,0], positioning:'bottom-left'});
map.addOverlay(overlay);

map.on('pointermove', (e)=>{
  const feat = map.forEachFeatureAtPixel(e.pixel,f=>f);
  if(feat && feat.get('name')){
    tooltip.innerHTML = feat.get('name');
    overlay.setPosition(e.coordinate);
    tooltip.style.display = 'block';
  }else{
    tooltip.style.display = 'none';
  }
});

/* ------------------------------------------------------------------ */
/* 3.  Catalogue sidebar                                              */
/* ------------------------------------------------------------------ */
let catalogue=[];
fetch('storms/storms.json')
  .then(r=>r.ok?r.json():Promise.reject(r.status))
  .then(d=>{catalogue=d; renderList(d,true);})
  .catch(c=>alert(`storms.json – HTTP ${c}`));

const listEl   = document.getElementById('storm-list');
const searchEl = document.getElementById('search');

function renderList(arr,yearDesc=false){
  const sorted = arr.slice().sort((a,b)=>{
    if(yearDesc){const y=b.year-a.year; if(y) return y;}
    return a.id.localeCompare(b.id);
  });
  listEl.innerHTML='';
  sorted.forEach(s=>{
    const li=document.createElement('li');
    li.className='cursor-pointer hover:bg-blue-100 p-2 rounded';
    li.textContent=`${s.id} – ${s.name||'Unnamed'} (${s.year})`;
    li.onclick=()=>loadStorm(s);
    listEl.appendChild(li);
  });
}

searchEl.oninput=e=>{
  const q=e.target.value.trim().toLowerCase();
  if(!q){renderList(catalogue,true);return;}
  renderList(catalogue.filter(s=>
    s.id.toLowerCase().includes(q)||
    (s.name&&s.name.toLowerCase().includes(q))||
    String(s.year).includes(q)
  ),false);
};

/* ------------------------------------------------------------------ */
/* 4.  Storm loader (KML → vector layer)                              */
/* ------------------------------------------------------------------ */
function loadStorm(storm){
  fetch(storm.kml)
    .then(r=>r.text())
    .then(xml=>{
      // Parse KML → EPSG:3857 (Web-Mercator) in one step
      const fmt      = new ol.format.KML({extractStyles:true});
      const features = fmt.readFeatures(xml,{
        dataProjection   : 'EPSG:4326',
        featureProjection: 'EPSG:3857'
      });

      vectorSource.clear();
      vectorSource.addFeatures(features);

      const ext = vectorSource.getExtent();
      map.getView().fit(ext, {padding:[40,40], maxZoom:7});
    })
    .catch(()=>alert(`Could not load ${storm.kml}`));
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tropical Cyclone Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.2.1/ol.css">
  <script src="https://cdn.jsdelivr.net/npm/ol@v10.2.1/dist/ol.js"></script>
  <style>
    html,body{height:100%}
    #map{height:100%;width:100%}
    .ol-tooltip{position:absolute;background:rgba(255,255,255,.9);border:none;padding:1px 4px;border-radius:2px;font-size:10px;font-weight:600;pointer-events:none;white-space:nowrap}
    .ol-popup{position:absolute;background-color:white;box-shadow:0 1px 4px rgba(0,0,0,0.2);padding:15px;border-radius:10px;border:1px solid #cccccc;bottom:12px;left:-50px;min-width:150px}
    .ol-popup:after,.ol-popup:before{top:100%;border:solid transparent;content:" ";height:0;width:0;position:absolute;pointer-events:none}
    .ol-popup:after{border-top-color:white;border-width:10px;left:48px;margin-left:-10px}
    .ol-popup:before{border-top-color:#cccccc;border-width:11px;left:48px;margin-left:-11px}
    .ol-popup-closer{text-decoration:none;position:absolute;top:2px;right:8px}
    .ol-popup-closer:after{content:"✖"}
  </style>
</head>
<body class="h-full w-full flex">
  <aside class="w-80 p-4 bg-gray-100 overflow-y-auto">
    <h1 class="text-2xl font-bold mb-4">Tropical Cyclones</h1>
    <input id="search" type="text" placeholder="Search storms…" class="mb-4 w-full p-2 border rounded" />
    <ul id="storm-list" class="space-y-2"></ul>
  </aside>
  <main class="flex-1"><div id="map"></div></main>
  <script>
    /* ---------- Map ---------- */
    const map = new ol.Map({
      target: 'map',
      layers: [new ol.layer.Tile({source: new ol.source.OSM()})],
      view: new ol.View({center: ol.proj.fromLonLat([0, 15]), zoom: 2})
    });

    let currentLayer=null;
    let catalogue=[];

    /* ---------- Load catalogue ---------- */
    fetch('storms/storms.json')
      .then(r=>r.ok?r.json():Promise.reject(r.status))
      .then(data=>{ catalogue=data; renderList(data,true); })
      .catch(code=>alert(`storms.json error – HTTP ${code}`));

    const listEl=document.getElementById('storm-list');
    const searchEl=document.getElementById('search');

    function renderList(arr,sortDesc=false){
      const sorted=arr.slice().sort((a,b)=>{
        if(sortDesc){ const yr=b.year-a.year; if(yr!==0) return yr; }
        return a.id.localeCompare(b.id);
      });
      listEl.innerHTML='';
      sorted.forEach(s=>{
        const li=document.createElement('li');
        li.className='cursor-pointer hover:bg-blue-100 p-2 rounded';
        li.textContent=`${s.id} – ${s.name||'Unnamed'} (${s.year})`;
        li.onclick=()=>loadStorm(s);
        listEl.appendChild(li);
      });
    }

    searchEl.oninput=e=>{
      const q=e.target.value.trim().toLowerCase();
      if(!q){ renderList(catalogue,true); return; }
      renderList(catalogue.filter(s=>
        s.id.toLowerCase().includes(q)||
        (s.name&&s.name.toLowerCase().includes(q))||
        String(s.year).includes(q)
      ),false);
    };

    /* ---------- Dateline unwrapping ---------- */
    function unwrapAndClamp(feature){
      const geom=feature.getGeometry();
      const type=geom.getType();
      if(type==='LineString'){
        let ll=geom.getCoordinates().map(c=>ol.proj.toLonLat(c));
        // unwrap
        for(let i=1;i<ll.length;i++){
          let prev=ll[i-1][0], cur=ll[i][0];
          let diff=cur-prev;
          if(diff>180)   cur-=360;
          else if(diff<-180) cur+=360;
          ll[i][0]=cur;
        }
        // shift entire line into [-180,180]
        const lons=ll.map(c=>c[0]);
        const meanLon=lons.reduce((a,b)=>a+b,0)/lons.length;
        let shift=0;
        if(meanLon>180) shift=-360;
        if(meanLon<-180) shift=360;
        if(shift!==0) ll=ll.map(([lon,lat])=>[lon+shift,lat]);
        geom.setCoordinates(ll.map(c=>ol.proj.fromLonLat(c)));
      }else if(type==='Point'){
        let [lon,lat]=ol.proj.toLonLat(geom.getCoordinates());
        if(lon>180) lon-=360;
        if(lon<-180) lon+=360;
        geom.setCoordinates(ol.proj.fromLonLat([lon,lat]));
      }
    }

    /* ---------- Load storm ---------- */
    function loadStorm(storm){
      if(currentLayer) map.removeLayer(currentLayer);
      const src=new ol.source.Vector({url:storm.kml,format:new ol.format.KML(),wrapX:false});
      currentLayer=new ol.layer.Vector({
        source:src,
        style:feat=>{
          const t=feat.getGeometry().getType();
          if(t==='LineString') return new ol.style.Style({stroke:new ol.style.Stroke({color:'#ff0000',width:2})});
          if(t==='Point') return new ol.style.Style({image:new ol.style.Circle({radius:4,fill:new ol.style.Fill({color:'#ff0000'}),stroke:new ol.style.Stroke({color:'#fff',width:1})})});
        }
      });
      map.addLayer(currentLayer);

      src.once('change',()=>{
        if(src.getState()!=='ready') return;
        src.getFeatures().forEach(unwrapAndClamp);
        const ext=src.getExtent();
        if(!ol.extent.isEmpty(ext)) map.getView().fit(ext,{padding:[50,50,50,50],duration:400});
      });
    }

    /* ---------- Popup ---------- */
    const popupEl=document.createElement('div'); popupEl.className='ol-popup';
    const popupCloser=document.createElement('a'); popupCloser.className='ol-popup-closer'; popupCloser.href='#';
    const popupContent=document.createElement('div');
    popupEl.appendChild(popupCloser); popupEl.appendChild(popupContent);
    const popup=new ol.Overlay({element:popupEl,autoPan:true,autoPanAnimation:{duration:250}});
    map.addOverlay(popup);
    popupCloser.onclick=()=>{popup.setPosition(undefined); popupCloser.blur(); return false;};
    map.on('click',evt=>{
      const feat=map.forEachFeatureAtPixel(evt.pixel,f=>f);
      if(feat){
        const p=feat.getProperties();
        let html='';
        if(p.name) html+=`<h2 style=\"margin:0 0 5px 0;font-size:14px\">${p.name}</h2>`;
        if(p.description) html+=`<div style=\"font-size:12px\">${p.description}</div>`;
        if(html){ popupContent.innerHTML=html; popup.setPosition(evt.coordinate);} }
      else popup.setPosition(undefined);
    });
    map.on('pointermove',evt=>{map.getTargetElement().style.cursor=map.hasFeatureAtPixel(evt.pixel)?'pointer':'';});
  </script>
</body>
</html>
